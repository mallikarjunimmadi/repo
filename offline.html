<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV ‚Üí Interactive Grapher (Offline)</title>

<!-- === OFFLINE: embed Papa Parse === -->
<script>
/* PASTE the minified Papa Parse here.
   You can copy it exactly from your working offline file. */
</script>

<!-- === OFFLINE: embed Plotly === -->
<script>
/* PASTE the minified Plotly build here (e.g., plotly-2.35.2.min.js).
   You can copy it exactly from your working offline file. */
</script>

<style>
  /* (unchanged styles)‚Ä¶ */
  :root[data-theme="dark"]{ --accent:#2563eb; --danger:#ef4444; --bg:#0b1020; --panel:#121a2b; --text:#e6e9f0; --muted:#9aa3b2; --border:#1d2740; }
  :root[data-theme="light"]{ --accent:#2563eb; --danger:#ef4444; --bg:#f6f7fb; --panel:#ffffff; --text:#0b1020; --muted:#5b6475; --border:#d9dee8; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:16px}
  #themeToggle{margin-left:auto;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer;display:flex;align-items:center}
  #themeIcon{font-size:16px;line-height:1}

  .controls{position:relative;display:grid;grid-template-columns:360px minmax(0,1fr);gap:12px;padding:10px 14px 0;align-items:start;transition:grid-template-columns .18s ease}
  .controls.collapsed{grid-template-columns:minmax(0,1fr)}
  @media(max-width:960px){.controls{grid-template-columns:1fr}}
  .left-col{display:grid;gap:10px;align-self:start;position:sticky;top:54px;max-height:calc(100vh - 66px)}
  .controls.collapsed .left-col{display:none}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:8px}
  input[type=file]{width:100%;background:transparent;border:1px dashed var(--border);color:var(--muted);padding:8px;border-radius:6px}
  .searchbox{display:flex;gap:6px;margin:6px 0;flex-wrap:wrap}
  .searchbox input{flex:1 1 160px;background:transparent;border:1px solid var(--border);color:var(--text);padding:6px;border-radius:6px}
  .btn{border:1px solid var(--border);background:transparent;color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-toggle.active{background:var(--accent);color:#fff;border-color:transparent}
  .select-wrap{height:56vh;overflow:auto;border:1px solid var(--border);border-radius:6px}
  .select-wrap label{display:flex;align-items:center;gap:6px;padding:6px 8px;border-bottom:1px solid var(--border);font-size:13px;cursor:pointer}
  .badge{margin-left:auto;font-size:11px;padding:1px 6px;border-radius:999px;background:rgba(127,127,127,.12);color:var(--muted)}
  .actions{display:flex;gap:8px;align-items:center;margin:10px 14px;flex-wrap:wrap;overflow-x:auto}
  main{padding:0 14px 16px}
  .chart{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;min-height:70vh;margin:10px 0}
  .chart.small{min-height:42vh}
  .meta{color:var(--muted);font-size:12px;margin-top:6px}

  .jumper{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:20;opacity:0;pointer-events:none;transition:opacity .15s ease}
  .jumper.visible{opacity:1;pointer-events:auto}
  .fab{border:1px solid var(--border);background:var(--panel);color:var(--text);width:38px;height:38px;border-radius:999px;display:grid;place-items:center;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.25)}
  .fab:hover{background:var(--accent);color:#fff;border-color:transparent}

  .pane-handle{position:fixed;width:26px;height:56px;display:grid;place-items:center;border-radius:999px;background:var(--panel);color:var(--text);border:1px solid var(--border);box-shadow:0 4px 16px rgba(0,0,0,.25);z-index:15;cursor:pointer;user-select:none}
  .pane-handle:hover{background:var(--accent);color:#fff;border-color:transparent}
  .pane-handle span{font-size:16px;line-height:1}
  .controls.collapsed + .pane-handle span{transform:rotate(180deg)}
</style>
</head>
<body>
<header>
  <h1>CSV ‚Üí Interactive Grapher</h1>
  <button id="themeToggle" class="btn" aria-label="Toggle theme"><span id="themeIcon">üåô</span></button>
</header>

<section class="controls" id="controls">
  <div class="left-col" id="leftCol">
    <div class="panel">
      <strong style="font-size:13px">Load CSV</strong>
      <input id="fileInput" type="file" accept=".csv,text/csv"/>
      <div id="fileInfo" class="meta"></div>
    </div>
    <div class="panel">
      <div class="searchbox">
        <input id="search" placeholder="Filter metrics‚Ä¶"/>
        <button class="btn" id="btnToggleFilter" title="Toggle: show selected vs all">Show Selected</button>
        <button class="btn" id="btnSelectAll" title="Check all metrics">Select all</button>
        <button class="btn" id="btnClearMetrics" title="Uncheck all metrics">Clear metrics</button>
      </div>
      <div id="metricList" class="select-wrap"></div>
    </div>
  </div>

  <div id="rightCol" style="position:relative;">
    <div class="actions">
      <button id="btnPlot" class="btn">Plot</button>
      <button id="btnResetZoom" class="btn" disabled>Reset Zoom</button>
      <button id="btnClear" class="btn" disabled>Clear Charts</button>
      <button id="btnIndividual" class="btn btn-toggle" title="Toggle: individual charts vs combined">Individual</button>
      <button id="btnEpoch" class="btn btn-toggle" title="Toggle: parse timestamps as epoch">Epoch</button>
      <button id="btnStrict" class="btn btn-toggle" title="Toggle: keep only rows where all selected metrics are numeric">Strict rows</button>
    </div>
    <main><div id="charts"></div></main>
  </div>
</section>

<button id="paneHandle" class="pane-handle" aria-label="Collapse/Expand metrics"><span>‚ùÆ</span></button>

<div class="jumper" id="jumper">
  <button id="jumpTop" class="fab" title="Jump to top">‚ñ≤</button>
  <button id="jumpBottom" class="fab" title="Jump to bottom">‚ñº</button>
</div>

<script>
/* ===== App JS (unchanged logic, trimmed for brevity) ===== */
/* Theme */
(function(){
  const saved=localStorage.getItem('csvgrapher-theme');
  const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const initial=saved || (prefersDark?'dark':'light');
  document.documentElement.setAttribute('data-theme', initial);
  updateThemeIcon();
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'light';
    const next=cur==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('csvgrapher-theme', next);
    updateThemeIcon();
    if(parsed) autoPlot();
  });
})();
function updateThemeIcon(){
  const icon=document.getElementById('themeIcon');
  const cur=document.documentElement.getAttribute('data-theme')||'light';
  icon.textContent=(cur==='dark')?'üåû':'üåô';
}

/* Elements & State */
const controls=document.getElementById('controls');
const rightCol=document.getElementById('rightCol');
const paneHandle=document.getElementById('paneHandle');
const fileInput=document.getElementById('fileInput');
const metricList=document.getElementById('metricList');
const searchInput=document.getElementById('search');
const btnToggleFilter=document.getElementById('btnToggleFilter');
const btnSelectAll=document.getElementById('btnSelectAll');
const btnClearMetrics=document.getElementById('btnClearMetrics');
const btnPlot=document.getElementById('btnPlot');
const btnClear=document.getElementById('btnClear');
const btnResetZoom=document.getElementById('btnResetZoom');
const btnIndividual=document.getElementById('btnIndividual');
const btnEpoch=document.getElementById('btnEpoch');
const btnStrict=document.getElementById('btnStrict');
const chartsDiv=document.getElementById('charts');
const fileInfo=document.getElementById('fileInfo');
const jumper=document.getElementById('jumper');
const jumpTop=document.getElementById('jumpTop');
const jumpBottom=document.getElementById('jumpBottom');

let parsed=null, showSelectedMode=false, individualMode=false, epochMode=false, strictMode=false;
let syncBlockedUntil=0; const SYNC_COOLDOWN_MS=160;
const now=()=>performance.now();
const suspendSync=()=>{ syncBlockedUntil=now()+SYNC_COOLDOWN_MS; };
const canSync=()=> now()>syncBlockedUntil;

/* Utils */
const debounce=(fn,ms=150)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
function isNumeric(x){ if(x===''||x==null) return false; return isFinite(Number(x)); }
function robustParseTimestamp(v){
  if(v==null||v==='') return null;
  const s=String(v).trim();
  if(/^\d+$/.test(s)){ const x=Number(s); if(x>1e12) return new Date(x); if(x>1e9) return new Date(x*1000); return new Date(x); }
  if(/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}(:\d{2})?$/.test(s)){ const d=new Date(s.replace(' ','T')); if(!isNaN(d)) return d; }
  const d2=new Date(s); if(!isNaN(d2)) return d2;
  const m=/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(s); if(m){ const now=new Date(); now.setHours(+m[1],+m[2],+(m[3]||0),0); return now; }
  return null;
}
function parseTimestamp(v){
  const s=String(v||'').trim();
  if(epochMode && /^\d+$/.test(s)){
    const x=Number(s);
    if(x>1e12) return new Date(x);
    if(x>1e9)  return new Date(x*1000);
    return new Date(x);
  }
  return robustParseTimestamp(v);
}
function getThemeColors(){
  const cs=getComputedStyle(document.documentElement);
  return { panel:cs.getPropertyValue('--panel').trim(), text:cs.getPropertyValue('--text').trim(), grid:'rgba(127,127,127,.2)' };
}

/* Sidebar handle + chart resize */
function charts(){ return Array.from(chartsDiv.querySelectorAll('.chart')); }
function positionHandle(){
  const rect=rightCol.getBoundingClientRect();
  const x = rect.left + window.scrollX - 13;
  const y = window.scrollY + (window.innerHeight/2);
  paneHandle.style.left=x+'px'; paneHandle.style.top=y+'px';
}
function resizeCharts(){ charts().forEach(div=>{ try{ Plotly.Plots.resize(div); }catch(_){} }); }
window.addEventListener('resize', debounce(()=>{ positionHandle(); resizeCharts(); },50));
window.addEventListener('scroll', debounce(positionHandle,50));
controls.addEventListener('transitionend', (e)=>{ if(e.propertyName==='grid-template-columns'){ positionHandle(); requestAnimationFrame(resizeCharts); }});
let sidebarCollapsed=false;
paneHandle.addEventListener('click', ()=>{
  sidebarCollapsed=!sidebarCollapsed;
  controls.classList.toggle('collapsed', sidebarCollapsed);
  positionHandle(); requestAnimationFrame(resizeCharts);
});

/* File load (Papa.parse is already available offline) */
fileInput.addEventListener('change',()=>{
  const f=fileInput.files?.[0]; if(!f) return;
  Papa.parse(f,{header:true,skipEmptyLines:true,worker:true,complete:(res)=>{
    const h=res.meta.fields || (res.data[0]?Object.keys(res.data[0]):[]);
    if(!res.data.length || h.length<2){ alert('Need at least 2 columns: timestamp + one metric.'); return; }
    const tsKey=h[0];
    const rows=res.data.map(r=>{
      const obj={}; h.forEach(k=>obj[k]=r[k]);
      const d=parseTimestamp(r[tsKey]); if(d) obj[tsKey]=d;
      return obj;
    });
    parsed={headers:h,rows,tsKey};
    buildMetricList();
    fileInfo.textContent=`${f.name} ¬∑ ${rows.length} rows ¬∑ ${h.length} cols`;
    btnClear.disabled=false; btnResetZoom.disabled=true;
    const first = metricList.querySelector('input[type="checkbox"]:not([disabled])'); if(first && !first.checked) first.checked = true;
    applyFilter(); autoPlot(); positionHandle();
  }});
});

/* Metric list + filter */
function buildMetricList(){
  metricList.innerHTML=""; if(!parsed) return;
  const {headers,rows}=parsed; const sample=Math.min(100, rows.length);
  const numeric=new Set();
  headers.slice(1).forEach(h=>{ let hits=0; for(let i=0;i<sample;i++){ if(isNumeric(rows[i][h])){ hits++; if(hits>=2) break; } } if(hits>0) numeric.add(h); });
  headers.slice(1).forEach(h=>{
    const lab=document.createElement('label'); lab.dataset.metric=h;
    lab.innerHTML=`<input type="checkbox" ${numeric.has(h)?'':'disabled'}/> <span>${h}</span> <span class="badge">${numeric.has(h)?'num':'txt'}</span>`;
    metricList.appendChild(lab);
  });
  metricList.addEventListener('change', debounce(()=>{ applyFilter(); autoPlot(); },120), { once:false });
}
searchInput.addEventListener('input', ()=>applyFilter());
btnToggleFilter.addEventListener('click', ()=>{
  showSelectedMode=!showSelectedMode;
  btnToggleFilter.textContent = showSelectedMode ? 'Show All' : 'Show Selected';
  applyFilter();
});
btnSelectAll.addEventListener('click', ()=>{
  const visible=[...metricList.querySelectorAll('label')]
    .filter(l=>l.style.display!=='none')
    .map(l=>l.querySelector('input[type="checkbox"]:not([disabled])'));
  visible.forEach(cb=>{ if(cb) cb.checked=true; });
  autoPlot();
});
btnClearMetrics.addEventListener('click', ()=>{
  [...metricList.querySelectorAll('input[type="checkbox"]')].forEach(cb=>cb.checked=false);
  autoPlot();
});
function applyFilter(){
  const q=searchInput.value.trim().toLowerCase();
  [...metricList.children].forEach(l=>{
    const name=l.dataset.metric.toLowerCase();
    const passesSearch = q ? name.includes(q) : true;
    const checked = l.querySelector('input').checked;
    const passesMode = showSelectedMode ? checked : true;
    l.style.display = (passesSearch && passesMode) ? 'flex' : 'none';
  });
}

/* Zoom sync */
function broadcast(update){ if(!update || Object.keys(update).length===0) return; suspendSync(); charts().forEach(div=>Plotly.relayout(div, update)); }
function buildRelayoutFromEvent(ed){
  const u={};
  if(!ed) return u;
  if('xaxis.range[0]' in ed && 'xaxis.range[1]' in ed){ u['xaxis.range']=[ed['xaxis.range[0]'], ed['xaxis.range[1]']]; }
  else if('xaxis.autorange' in ed){ u['xaxis.autorange']=true; }
  if('yaxis.range[0]' in ed && 'yaxis.range[1]' in ed){ u['yaxis.range']=[ed['yaxis.range[0]'], ed['yaxis.range[1]']]; }
  else if('yaxis.autorange' in ed){ u['yaxis.autorange']=true; }
  return u;
}
function attachSync(gd){
  gd.on('plotly_doubleclick', (e)=>{
    e && e.event && e.event.preventDefault && e.event.preventDefault();
    const xa=gd._fullLayout.xaxis, ya=gd._fullLayout.yaxis;
    if(e && e.event && e.event.shiftKey && xa.range && ya.range){
      const [x0,x1]=xa.range, [y0,y1]=ya.range;
      const xm=(new Date(x0).getTime()+new Date(x1).getTime())/2;
      const ym=(y0+y1)/2;
      const xHalf=(new Date(x1).getTime()-new Date(x0).getTime())/4;
      const yHalf=(y1-y0)/4;
      broadcast({'xaxis.range':[new Date(xm-xHalf),new Date(xm+xHalf)],'yaxis.range':[ym-yHalf,ym+yHalf]});
    } else {
      broadcast({'xaxis.autorange':true,'yaxis.autorange':true});
    }
    return false;
  });
  gd.on('plotly_relayout', (ed)=>{
    if(!canSync()) return;
    const update=buildRelayoutFromEvent(ed);
    if(Object.keys(update).length===0) return;
    suspendSync();
    charts().forEach(other=>{ if(other!==gd){ Plotly.relayout(other, update); } });
  });
}

/* Jumpers */
function updateJumperVisibility(){ jumper.classList.toggle('visible', charts().length > 1); }
jumpTop.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));
jumpBottom.addEventListener('click', ()=>{
  const last=charts().at(-1);
  if(last){ last.scrollIntoView({behavior:'smooth',block:'end'}); }
});

/* Plotly config */
const PLOTLY_CONFIG={ responsive:true, displaylogo:false, scrollZoom:true, doubleClick:'reset' };

/* Plot actions */
btnPlot.addEventListener('click', ()=>autoPlot());
btnClear.addEventListener('click', ()=>{
  chartsDiv.innerHTML=""; btnResetZoom.disabled=true; updateJumperVisibility(); resizeCharts();
});
btnResetZoom.addEventListener('click', ()=>{ broadcast({'xaxis.autorange':true,'yaxis.autorange':true}); });
btnIndividual.addEventListener('click', ()=>{ individualMode=!individualMode; btnIndividual.classList.toggle('active', individualMode); autoPlot(); });
btnEpoch.addEventListener('click', ()=>{
  epochMode=!epochMode; btnEpoch.classList.toggle('active', epochMode);
  if(parsed){ const {rows,tsKey}=parsed; rows.forEach(r=>{ const d=parseTimestamp(r[tsKey]); if(d) r[tsKey]=d; }); }
  autoPlot();
});
btnStrict.addEventListener('click', ()=>{ strictMode=!strictMode; btnStrict.classList.toggle('active', strictMode); autoPlot(); });

function autoPlot(){
  if(!parsed){ positionHandle(); return; }
  const selected=[...metricList.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>cb.closest('label').dataset.metric);
  if(selected.length===0){ chartsDiv.innerHTML=""; btnResetZoom.disabled=true; updateJumperVisibility(); positionHandle(); resizeCharts(); return; }

  const {rows,tsKey}=parsed;
  const xs=rows.map(r=> r[tsKey] instanceof Date ? r[tsKey] : parseTimestamp(r[tsKey]));
  let idx=xs.map((d,i)=>({d,i})).filter(o=>o.d instanceof Date);
  if(strictMode){ idx=idx.filter(({i})=> selected.every(m=> isNumeric(rows[i][m]))); }
  const x=idx.map(o=>o.d);
  const traces=selected.map(metric=>{
    const y=idx.map(({i})=>{ const n=Number(rows[i][metric]); return isFinite(n)?n:null; });
    return { x,y,type:'scatter',mode:'lines',name:metric,hovertemplate:'%{x}<br>%{y}<extra>'+metric+'</extra>' };
  });

  chartsDiv.innerHTML="";
  if(individualMode){
    selected.forEach((metric,k)=>{
      const div=document.createElement('div'); div.className='chart small'; chartsDiv.appendChild(div);
      Plotly.newPlot(div,[traces[k]],layoutWithLegend(metric,x),PLOTLY_CONFIG).then(gd=>attachSync(gd));
    });
  }else{
    const div=document.createElement('div'); div.className='chart'; chartsDiv.appendChild(div);
    Plotly.newPlot(div,traces,layoutWithLegend('Compare: '+selected.join(' vs '),x),PLOTLY_CONFIG).then(gd=>attachSync(gd));
  }
  btnResetZoom.disabled=false; updateJumperVisibility(); positionHandle(); requestAnimationFrame(resizeCharts);
}

function layoutWithLegend(title,x){
  const colors=getThemeColors();
  const span = x && x.length ? [x[0], x[x.length-1]] : null;
  return {
    title:{ text:title, font:{size:13,color:colors.text} },
    paper_bgcolor:colors.panel, plot_bgcolor:colors.panel,
    margin:{ t:30,r:14,b:70,l:50 },
    xaxis:{ title:'Time', type:'date', gridcolor:colors.grid, range:span||undefined, zeroline:false, color:colors.text },
    yaxis:{ title:'Value', gridcolor:colors.grid, zeroline:false, color:colors.text },
    legend:{ orientation:'h', y:-0.35, x:0.5, xanchor:'center', font:{color:colors.text} }
  };
}

document.addEventListener('DOMContentLoaded', ()=>{ positionHandle(); resizeCharts(); });
document.addEventListener('keydown', e=>{ if(e.key==='Enter' && parsed) autoPlot(); });
</script>
</body>
</html>
